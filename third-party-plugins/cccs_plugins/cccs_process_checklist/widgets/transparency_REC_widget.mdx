import React, { useEffect, useState } from 'react';
import { PieChart } from 'aiverify-shared-library/charts';


export const ib_cid = "transparency";

export const Recommendation = ({ data02 }) => {
  const responses = data02.map(item => item.name);
  const yesCount = data02.find(item => item.name === 'Yes')?.value || 0;
  const noCount = data02.find(item => item.name === 'No')?.value || 0;
  const naCount = data02.find(item => item.name === 'Not Applicable')?.value || 0; 

  let recommendation;
  if (noCount >= 1) {
    //Failed Test
    recommendation = `The market would trend towards positive outcomes if models were themselves reliable and accurate, and if consumers had the right information about them to make informed decisions. In cases where AI models have limitations, users should be appropriately informed about these constraints.
    The business should ensure performance claims are verifiable and clearly state specific metrics, allowing consumers to understand features, capabilities, and limitations. Consumers should be informed about the AI model's accuracy in its output so that consumers can make informed choices when using the model. Any AI-driven mechanisms that influence consumer behaviour should be transparent and avoid deceptive design patterns that could exploit consumer vulnerabilities. If the business is making claims that turn out to be false or misleading to consumers without any disclaimer or disclosure of limitations, or employs deceptive nudging mechanisms, the business could be engaging in an unfair practice as defined under the Consumer Protection (Fair Trading) Act.`;
  } else {
    //Passed Test
    recommendation = `The market would trend towards positive outcomes if models were themselves reliable and accurate, and if consumers had the right information about them to make informed decisions. In cases where AI models have limitations, users should be appropriately informed about these constraints.
    The business has implemented measures to ensure its claims about AI models are accurate, verifiable, and not misleading. The business provides information about the AI system’s limitations and risks in a clear and accessible manner and maintains transparency about how AI-driven recommendations may influence consumer decisions. `;
  }

  return (
    <div className="recommendation">
      <h3 className="c-primary">Our Recommendation:</h3>
      <div style={{paddingTop: "5px"}}>{recommendation}</div>
    </div>
  );
};

export const MissingCriteria = ({ data }) => {
    const questionsDict = {
        "5_1_1": "5.1.1 Claims comparing the business’s AI models with another competing model should clearly state specific metrics and criteria.",
        "5_1_2": "5.1.2 Performance claims made by the business should be verifiable and substantiated.",
        "5_1_3": "5.1.3 Consumers should be able to understand the features and capabilities easily.",
        "5_2_1": "5.2.1 Ensure that users are informed of the AI model’s information (including limitations in accuracy, if any).",
        "5_2_2": "5.2.2 Ensure that users are able to make informed choices when using the AI model (including the knowledge of when an AI model is being used).",
        "5_3_1": "5.3.1 Ensure that businesses actively monitor their AI system’s interface and recommendation pattern to identify and prevent AI systems to be used as a means to mislead consumers.",
        "5_3_2": "5.3.2 Ensure that AI recommendation systems are continuously monitored to ensure that they are not meant to impair the independent and informed decision making of a consumer.",
        "5_3_3": "5.3.3 Ensure that clear standards exist for presenting choices to consumers in a way that promotes independent and informed decision-making and not designed in a way to mislead consumer choices."
    };

    const noResponses = data
        .filter(response => response.response === 'No')
        .map(response => response.id);

    const missingCriteriaQuestions = noResponses.map(id => questionsDict[id] || "Question not found");

    return (
        <div style={{ paddingLeft: "10px", paddingRight: "10px", paddingTop: "15px" }}>
            <h3 className="c-primary">Company did not implement the following testable criteria fully:</h3>
            <ul style={{ paddingLeft: "13px", paddingRight: "0px", marginTop: "5px" }}>
                {missingCriteriaQuestions.map((question, index) => (
                    <li key={index} style={{ paddingBottom: "9px" }}>
                        {question}
                    </li>
                ))}
            </ul>
        </div>
    );
}

export const MyComponent = (props) => {
    const [data02, setData02] = useState([]);
    const [dataWithIds, setDataWithIds] = useState([]);

    useEffect(() => {
        const responses = [
            props.getIBData(ib_cid)["5_1_1"],
            props.getIBData(ib_cid)["5_1_2"],
            props.getIBData(ib_cid)["5_1_3"],
            props.getIBData(ib_cid)["5_2_1"],
            props.getIBData(ib_cid)["5_2_2"],
            props.getIBData(ib_cid)["5_3_1"],
            props.getIBData(ib_cid)["5_3_2"],
            props.getIBData(ib_cid)["5_3_3"]
        ];

        const yesCount = responses.filter(response => response === 'Yes').length;
        const noCount = responses.filter(response => response === 'No').length;
        const naCount = responses.filter(response => response === 'NA').length;

        setData02([
            { name: "Not Applicable", value: naCount }, // Blue
            { name: "No", value: noCount }, // Orange
            { name: "Yes", value: yesCount } // Green
        ]);

        const ids = [
            "5_1_1", "5_1_2", "5_1_3", "5_2_1", "5_2_2", "5_3_1", "5_3_2", "5_3_3"
        ];

        const responseswithID = ids.map(id => ({
            id: id,
            response: props.getIBData(ib_cid)[id]
        }));

        setDataWithIds(responseswithID);

    }, [props]);

// for grid display - display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0px", padding: "0px" 
// for donut chart - pies={[{ dataKey: "value", data: data02, innerRadius: 65, outerRadius: 120, labelLine: false, label: "renderCustomizedPieLabel" }]} 

    return (
        <div style={{ width:"100%"}}>
            <div className="aiv-panel">
                <h2>CCCS Recommendations</h2>
            </div>
            <div style={{ padding:"10px", textAlign: "center" }}>
                <h2 className="c-primary">Principle: Transparency (Consumer Protection)</h2>
            </div>
            <h4 style={{paddingLeft: "10px", paddingRight: "10px"}}>
                Brief overview of principle:  Ensures clear and truthful communication about AI capabilities and prevents misleading claims or deceptive practices. This involves providing accurate descriptions of the AI system’s capabilities and limitations, and offering explanations that are understandable to users. The market would trend towards positive outcomes if models were themselves reliable and accurate, and if consumers had the right information about them to make informed decisions. In cases where AI models have limitations, users should be appropriately informed about these constraints.
            </h4>
            <div style={{ height:"400px", padding:"5px" }}>
                <PieChart
                    pies={[{ dataKey: "value", data: data02, labelLine: false, label: "renderCustomizedPieLabel" }]} 
                />
            </div>
            <div style={{ paddingLeft: "10px", paddingRight: "10px", paddingTop: "10px"}}>
                <Recommendation data02={data02} />
            </div>
            <div style={{paddingLeft: "10px", paddingRight: "10px", paddingTop: "15px"}}>
                <h3 className="c-primary">Summmary Justification:</h3>
                <div style={{paddingTop: "3px"}}>{props.getIBData(ib_cid)["5_summary"]}</div>
            </div>
            <div>
                <MissingCriteria data={dataWithIds} />
            </div>
        </div>
    );
};

export default MyComponent;
